# Integration Test Workflow
# Runs integration tests by patching component into test targets
#
# Default test targets: axvisor, starry
# Inputs:
#   crate_name: Component crate name (required, auto-detected if empty)
#   test_targets: Test targets to run (comma-separated or "all")
#
# Workflow:
# 1. Checkout component (the caller repo)
# 2. Checkout test target (axvisor/starry)
# 3. Patch target's Cargo.toml to use component
# 4. Run tests in target directory

name: Test

on:
  workflow_call:
    inputs:
      crate_name:
        description: 'Component crate name (auto-detected from Cargo.toml if empty)'
        required: false
        default: ''
        type: string
      test_targets:
        description: 'Test targets (comma-separated or "all")'
        required: false
        default: 'all'
        type: string
    secrets:
      token:
        description: 'GitHub token with access to target repositories (PAT or GITHUB_TOKEN)'
        required: true

jobs:
  # ========== Axvisor Tests ==========
  axvisor:
    name: "Axvisor: ${{ matrix.type }} - ${{ matrix.vmconfigs_name }}"
    strategy:
      matrix:
        include:
          # QEMU tests
          - type: qemu
            arch: aarch64
            vmconfigs: configs/vms/arceos-aarch64-qemu-smp1.toml
            vmconfigs_name: ArceOS
            vmimage_name: qemu_aarch64_arceos
          - type: qemu
            arch: aarch64
            vmconfigs: configs/vms/linux-aarch64-qemu-smp1.toml
            vmconfigs_name: Linux
            vmimage_name: qemu_aarch64_linux
          - type: qemu
            arch: x86_64
            vmconfigs: configs/vms/nimbos-x86_64-qemu-smp1.toml
            vmconfigs_name: NimbOS
            vmimage_name: qemu_x86_64_nimbos
          # Board tests
          - type: board
            board: phytiumpi
            vmconfigs: configs/vms/arceos-aarch64-e2000-smp1.toml
            vmconfigs_name: ArceOS
          - type: board
            board: phytiumpi
            vmconfigs: configs/vms/linux-aarch64-e2000-smp1.toml
            vmconfigs_name: Linux
          - type: board
            board: roc-rk3568-pc
            vmconfigs: configs/vms/arceos-aarch64-rk3568-smp1.toml
            vmconfigs_name: ArceOS
          - type: board
            board: roc-rk3568-pc
            vmconfigs: configs/vms/linux-aarch64-rk3568-smp1.toml
            vmconfigs_name: Linux
      fail-fast: false
    runs-on:
      - self-hosted
      - linux
      - ${{ matrix.type == 'qemu' && 'intel' || matrix.board }}

    steps:
      - name: Filter test targets
        id: filter
        run: |
          INPUT="${{ inputs.test_targets }}"
          if [ "$INPUT" = "all" ] || [ -z "$INPUT" ] || echo ",$INPUT," | grep -q ",axvisor,"; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Clean up workspace
        if: steps.filter.outputs.should_run == 'true'
        run: |
          [ -d .git ] && git submodule deinit -f . || true
          [ -d .git/modules ] && rm -rf .git/modules || true
          [ -d .git ] && git clean -ffdx || true

      - name: Checkout component
        if: steps.filter.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          path: component

      - name: Checkout axvisor
        if: steps.filter.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.token }}
          repository: arceos-hypervisor/axvisor
          ref: main
          path: axvisor
          submodules: recursive

      - name: Get component crate name
        if: steps.filter.outputs.should_run == 'true'
        id: component
        working-directory: component
        run: |
          if [ -n "${{ inputs.crate_name }}" ]; then
            CRATE_NAME="${{ inputs.crate_name }}"
          else
            CRATE_NAME=$(cargo tree 2>/dev/null | head -1 | cut -d' ' -f1 || basename $(pwd))
          fi
          echo "crate_name=$CRATE_NAME" >> $GITHUB_OUTPUT

      - name: Apply patch to Cargo.toml
        if: steps.filter.outputs.should_run == 'true'
        working-directory: axvisor
        run: |
          CRATE_NAME="${{ steps.component.outputs.crate_name }}"
          echo "" >> Cargo.toml
          echo "[patch.crates-io]" >> Cargo.toml
          echo "$CRATE_NAME = { path = \"../component\" }" >> Cargo.toml
          echo "Applied patch:"
          tail -3 Cargo.toml

      - name: Install dependencies
        if: steps.filter.outputs.should_run == 'true'
        run: cargo +stable install ostool --version ^0.8

      - name: Download images and patch vm configs (QEMU only)
        if: steps.filter.outputs.should_run == 'true' && matrix.type == 'qemu'
        working-directory: axvisor
        run: |
          ls -lha .
          ls -lha modules/

          IMAGE_DIR="/tmp/.axvisor-images"
          IFS=',' read -ra CONFIGS <<< "${{ matrix.vmconfigs }}"
          IFS=',' read -ra IMAGES <<< "${{ matrix.vmimage_name }}"
          for i in "${!CONFIGS[@]}"; do
            img="${IMAGES[$i]}"
            img=$(echo "$img" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            config="${CONFIGS[$i]}"
            config=$(echo "$config" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            cargo xtask image download $img
            img_name="qemu-${{ matrix.arch }}"
            image_location=$(sed -n 's/^image_location[[:space:]]*=[[:space:]]*"\([^"]*\)".*/\1/p' "$config")

            case "$image_location" in
            "fs")
              echo "Filesystem storage mode - no config update needed"
              ;;
            "memory")
              sed -i 's|^kernel_path[[:space:]]*=.*|kernel_path = "'"${IMAGE_DIR}"'/'"$img"'/'"$img_name"'"|' "$config"
              echo "Memory storage mode - updating kernel_path"
              ;;
            *)
              echo "Unknown image_location: $image_location"
              exit 1
              ;;
            esac

            ROOTFS_IMG_PATH="${IMAGE_DIR}/$img/rootfs.img"

            if [ -f "${ROOTFS_IMG_PATH}" ]; then
              echo "Found rootfs.img, patching qemu-${{ matrix.arch }}.toml file..."
              sed -i 's|file=${workspaceFolder}/tmp/rootfs.img|file='"${ROOTFS_IMG_PATH}"'|' ".github/workflows/qemu-${{ matrix.arch }}.toml"
              echo "Rootfs setup completed"
            else
              echo "No rootfs.img found, removing rootfs device configuration from qemu-${{ matrix.arch }}.toml..."
              sed -i '/-device/,/virtio-blk-device,drive=disk0/d' ".github/workflows/qemu-${{ matrix.arch }}.toml"
              sed -i '/-drive/,/id=disk0,if=none,format=raw,file=${workspaceFolder}\/tmp\/rootfs.img/d' ".github/workflows/qemu-${{ matrix.arch }}.toml"
              sed -i 's/root=\/dev\/vda rw //' ".github/workflows/qemu-${{ matrix.arch }}.toml"
              echo "Rootfs device configuration removed"
            fi
          done

      - name: Run QEMU tests
        if: steps.filter.outputs.should_run == 'true' && matrix.type == 'qemu'
        working-directory: axvisor
        run: |
          export RUST_LOG=debug
          cargo xtask qemu \
            --build-config configs/board/qemu-${{ matrix.arch }}.toml \
            --qemu-config .github/workflows/qemu-${{ matrix.arch }}.toml \
            --vmconfigs ${{ matrix.vmconfigs }}

      - name: Run Board tests
        if: steps.filter.outputs.should_run == 'true' && matrix.type == 'board'
        working-directory: axvisor
        run: |
          echo $BOARD_POWER_RESET
          export RUST_LOG=debug
          cargo xtask uboot \
            --build-config configs/board/${{ matrix.board }}.toml \
            --uboot-config .github/workflows/uboot.toml \
            --vmconfigs ${{ matrix.vmconfigs }} \
            --bin-dir /home/runner/tftp

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.filter.outputs.should_run }}" = "true" ]; then
            echo "✅ Axvisor test completed"
          else
            echo "⏭️ Axvisor test skipped"
          fi

  # ========== Starry Tests ==========
  starry:
    name: "Starry: ${{ matrix.arch }}"
    strategy:
      fail-fast: false
      matrix:
        arch: [riscv64, loongarch64, aarch64, x86_64]
    runs-on: ubuntu-latest

    steps:
      - name: Filter test targets
        id: filter
        run: |
          INPUT="${{ inputs.test_targets }}"
          if [ "$INPUT" = "all" ] || [ -z "$INPUT" ] || echo ",$INPUT," | grep -q ",starry,"; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout component
        if: steps.filter.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          path: component

      - name: Checkout StarryOS
        if: steps.filter.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.token }}
          repository: Starry-OS/StarryOS
          ref: main
          path: starry
          submodules: recursive

      - name: Get component crate name
        if: steps.filter.outputs.should_run == 'true'
        id: component
        working-directory: component
        run: |
          if [ -n "${{ inputs.crate_name }}" ]; then
            CRATE_NAME="${{ inputs.crate_name }}"
          else
            CRATE_NAME=$(cargo tree 2>/dev/null | head -1 | cut -d' ' -f1 || basename $(pwd))
          fi
          echo "crate_name=$CRATE_NAME" >> $GITHUB_OUTPUT

      - name: Apply patch to Cargo.toml
        if: steps.filter.outputs.should_run == 'true'
        working-directory: starry
        run: |
          CRATE_NAME="${{ steps.component.outputs.crate_name }}"
          echo "" >> Cargo.toml
          echo "[patch.crates-io]" >> Cargo.toml
          echo "$CRATE_NAME = { path = \"../component\" }" >> Cargo.toml
          echo "Applied patch:"
          tail -3 Cargo.toml

      - uses: Swatinem/rust-cache@v2
        if: steps.filter.outputs.should_run == 'true'
        with:
          shared-key: test
          cache-targets: false

      - uses: arceos-org/setup-musl@v1
        if: steps.filter.outputs.should_run == 'true'
        with:
          arch: ${{ matrix.arch }}

      - name: Build
        if: steps.filter.outputs.should_run == 'true'
        working-directory: starry
        run: make ARCH=${{ matrix.arch }} build

      - name: Setup QEMU
        if: steps.filter.outputs.should_run == 'true'
        uses: arceos-org/setup-qemu@v1
        with:
          version: 10.1.0
          arch_list: ${{ matrix.arch }}

      - name: Prepare rootfs
        if: steps.filter.outputs.should_run == 'true'
        working-directory: starry
        run: make ARCH=${{ matrix.arch }} img

      - name: Test
        if: steps.filter.outputs.should_run == 'true'
        working-directory: starry
        run: scripts/ci-test.py ${{ matrix.arch }}

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.filter.outputs.should_run }}" = "true" ]; then
            echo "✅ Starry test completed"
          else
            echo "⏭️ Starry test skipped"
          fi
